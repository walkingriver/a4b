<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>13-Test-Driven Development with Angular</title>
  <style>
    html {
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 12px;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      html {
        background-color: white;
      }
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, Consolas, 'Lucida Console', monospace;
      font-size: 85%;
      margin: 0;
      hyphens: manual;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="test-driven-development-with-angular">Test-Driven Development
with Angular</h1>
<p>I tried something “new” recently. I built an Angular service in a
true TDD fashion. I wrote the tests first, discovering the service
interface along the way. This is how it went. I invite you to follow
along.</p>
<h2 id="background">Background</h2>
<p>I admit that I am often not a fan of writing unit tests for Angular
apps. The tooling I am using (Jasmine and Karma) feel like
afterthoughts. They work and they have gotten much better over the past
few years, but they still seem like they were written to bolt onto
Angular, rather than being built as part of the ecosystem.</p>
<p>Then I started thinking that maybe the problem is with me. Maybe I
despise writing tests because I have not truly adopted
test-driven-development in my Angular apps. I used to use TDD all the
time with .NET and C#.</p>
<p>So, I decided to go back to that philosophy and build a modest
service using strict TDD principles. This is how it went.</p>
<h2 id="the-service">The Service</h2>
<p>The service itself is simple enough. I want to build a means of
setting and retrieving two different unique IDs my app can use when
making service calls. The first is a “conversation ID” that will be set
as an HTTP header for all network calls for a specific user for a given
session. It will not change until the application user manually
refreshes the screen, closes the browser, or logs out and back in.</p>
<p>The second is the “correlation ID.” This will also get sent with each
HTTP call, but it changes with every request.</p>
<p>Not only will these IDs be set as custom HTTP headers on all web
requests, they will be logged with all such requests and responses. They
can then be used to correlate several layers of service requests and
responses back to the user and high-level function that initiated
them.</p>
<p>The name of my service is simply correlation. I created it with this
Angular CLI command:</p>
<pre class="shell"><code>npx ng g service services/correlation/Correlation</code></pre>
<pre><code>CREATE src/app/services/correlation/correlation.service.spec.ts (382 bytes)
CREATE src/app/services/correlation/correlation.service.ts (140 bytes)</code></pre>
<p>This creates two files in their own folder
at <code>./src/app/services/correlation</code>. I got a nearly-empty
service file and a test (spec) file with one test.</p>
<p>As I usually do, pre-pending <code>npx</code> causes the system to
use the locally-installed Angular CLI.</p>
<h2 id="the-generated-test">The Generated Test</h2>
<p>I want to start by reviewing the test code that was generated by the
Angular CLI. I do not mean for this to be a comprehensive introduction
to testing, but I will explain the basics. It should be enough for you
to follow along and also modify your own tests.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { TestBed } <span class="im">from</span> <span class="st">&#39;@angular/core/testing&#39;</span><span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { CorrelationService } <span class="im">from</span> <span class="st">&#39;./correlation.service&#39;</span><span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;CorrelationService&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> service<span class="op">:</span> CorrelationService<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    TestBed<span class="op">.</span><span class="fu">configureTestingModule</span>({})<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> TestBed<span class="op">.</span><span class="fu">inject</span>(CorrelationService)<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should be created&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(service)<span class="op">.</span><span class="fu">toBeTruthy</span>()<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>The first <code>import</code> line brings in the Angular testing
class called <code>TestBed</code>. This class contains most of the basic
testing framework.</p>
<p>The second pulls in the service to be tested, also known as the
“System Under Test,” or SUT.</p>
<h2 id="understanding-describe">Understanding <code>describe</code></h2>
<p>With most JavaScript testing frameworks, tests are organized into one
or more <code>describe</code> functions. These can be nested, as you
will see shortly.</p>
<p>The <code>describe</code> function is called with at least two
parameters:</p>
<ol type="1">
<li>The test label. In this case, the name of the service to be
tested.</li>
<li>The function that contains the tests themselves. Here it is an arrow
function.</li>
</ol>
<p>This function contains a single variable representing the service,
but nothing is assigned to it yet.</p>
<h2 id="grasping-beforeeach">Grasping <code>beforeEach</code></h2>
<p>Directly inside this function is another function call,
<code>beforeEach</code>, which itself contains another arrow function.
This function is called by the testing framework before every unit
test.</p>
<p>This one calls the <code>TestBed.configureTestingModule({})</code>,
and you can see that it is being passed an empty object as its only
argument. This is the options, and can accept just about everything a
normal Angular module can. Most tests use this to configure Angular’s
dependency injection system to inject test doubles required by the SUT.
My service has no dependencies, so there is nothing to configure.</p>
<h2 id="other-important-functions">Other Important Functions</h2>
<p>Not shown are some other functions that can contain setup/tear-down
instructions:</p>
<ul>
<li><code>beforeAll</code>: called once before any tests are run.</li>
<li><code>afterAll</code>: called once after all tests have been
run.</li>
<li><code>afterEach</code>: called after each unit test function.</li>
</ul>
<h2 id="understanding-it">Understanding <code>it</code></h2>
<p>This function defines a single unit test. You can create as many
<code>it</code> functions as you want inside your <code>describe</code>.
The generated test comes with a single <code>it</code> function. Its
signature matches that of <code>describe</code>, in that it takes a
label and a function defining the test.</p>
<p>When combined with its enclosing <code>describe</code>, the
<code>it</code> functions should read like this:</p>
<pre class="plaintext"><code>[describe Label] [it Label]: Pass/Fail</code></pre>
<p>Thus, when you read the one generated test, it should look like
this:</p>
<pre class="plaintext"><code>CorrelationService should be created: Pass</code></pre>
<p>Consider this phrasing when you create your own tests.</p>
<p>There is a lot more to Angular testing than this, but I wanted to
make sure I explained what you would be seeing below before I begun.</p>
<h2 id="understanding-the-service">Understanding the Service</h2>
<p>There are three primary things I need the service to do for me:</p>
<ol type="1">
<li>Give me the same conversation ID whenever I ask, unless one does not
exist. In that case, it needs to give me a new one and return it.</li>
<li>Give me a fresh correlation ID every time I request one. I should
never get the same ID twice.</li>
<li>Provide a way for me to force a fresh conversation ID.</li>
</ol>
<p>These rules allowed me to come up with the following tests. I’m using
Jasmine as my testing framework. I know a lot of people these days are
using Jest, but the concepts should be the same regardless of what you
use.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { TestBed } <span class="im">from</span> <span class="st">&#39;@angular/core/testing&#39;</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { CorrelationService } <span class="im">from</span> <span class="st">&#39;./correlation.service&#39;</span><span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;CorrelationService&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> service<span class="op">:</span> CorrelationService<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    TestBed<span class="op">.</span><span class="fu">configureTestingModule</span>({})<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> TestBed<span class="op">.</span><span class="fu">inject</span>(CorrelationService)<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should be created&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(service)<span class="op">.</span><span class="fu">toBeTruthy</span>()<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;resetConversationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return different values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;getConversationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return identical values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;getCorrelationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return different values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">getCorrelationId</span>()<span class="op">;</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">getCorrelationId</span>()<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Even if you are not intimately familiar with Angular testing in
Jasmine, I think these tests are easily understood.</p>
<p>However, these tests won’t run and they won’t even compile because
the functions on the service don’t exist yet.</p>
<h2 id="implementing-auto-generated-service-code">Implementing
Auto-Generated Service Code</h2>
<p>Fortunately, VS Code will do the heavy lifting for me. All I have to
do is put my edit cursor on one of the function names, click the yellow
light-bulb (for Auto Fix), and choose “Add all missing members,” as show
n in Figure 13.1.</p>
<figure>
<img src="image-14.png" alt="Figure 13.1, Auto import in VS Code" />
<figcaption aria-hidden="true">Figure 13.1, Auto import in VS
Code</figcaption>
</figure>
<p>The code it builds is not ideal and will still require some editing,
but at this point the tests will compile.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Injectable } <span class="im">from</span> <span class="st">&#39;@angular/core&#39;</span><span class="op">;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Injectable</span>({</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  providedIn<span class="op">:</span> <span class="st">&#39;root&#39;</span><span class="op">,</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> CorrelationService {</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetConversationId</span>() {</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Method not implemented.&#39;</span>)<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getConversationId</span>() {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Method not implemented.&#39;</span>)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCorrelationId</span>() {</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Method not implemented.&#39;</span>)<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>() {}</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="make-them-run-and-fail">Make Them Run (and Fail)</h2>
<p>Now I have code that compiles, implemented in such a way that all
three tests will fail with an expected exception. The first thing I need
to do is remove the exceptions. My class now looks like this:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> CorrelationService {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetConversationId</span>() {}</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getConversationId</span>() {}</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCorrelationId</span>() {}</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>() {}</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>I am afraid one of those tests will now pass, but should not. Each
function call in the test code evaluates to undefined. This causes the
test should return identical values on subsequent calls to pass, because
undefined equals undefined.</p>
<p>I will have to edit the tests. I have two choices. I can add three
more tests to ensure that no function returns undefined or I can add a
check for undefined in the test that is checking for equality.</p>
<p>Some purists believe that every test should have a single
assertion/expectation. I tend to be more of a pragmatist. If you are
testing one high level “thing,” then it is fine to have multiple
expectations in a single test.</p>
<p>The new test now looks like this, and fails as expected.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">describe</span>(<span class="st">&#39;getConversationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should return identical values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="fu">toBeDefined</span>()<span class="op">;</span> <span class="co">// New code</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Note I am only checking on the first result to be defined. If the
first call is defined and the second is not, the second expectation will
then fail. I will let you decide which approach makes sense for your
project.</p>
<h2 id="make-them-pass">Make Them Pass</h2>
<p>According to TDD principles, the next step is to write the least
amount of code that will cause the tests to pass. In theory, I should
not have to touch the tests again. In practice, I probably will. This is
a path of discovery, which I am writing as I go. Thus, you are learning
right along with me.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resetConversationId</span>() {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;mike&#39;</span><span class="op">;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">getConversationId</span>() {</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;mike&#39;</span><span class="op">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="fu">getCorrelationId</span>() {</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">&#39;mike&#39;</span><span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Technically, this will make the middle test pass, but not the others.
It is time to think about how the service is supposed to work.</p>
<h2 id="uuid">UUID</h2>
<p>The business rules call for some sort of semi-unique identifier
string. I plan to use a GUID or some variant thereof.</p>
<p>After a few seconds (ok, a minute or so) of research, I found the <a
href="https://www.npmjs.com/package/uuid">UUID npm package</a> (raw URL:
https://www.npmjs.com/package/uuid). I will use it to generate both my
conversation and correlation IDs.</p>
<p>Once the package is installed in my project, the CorrelationService
now looks like this.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Injectable } <span class="im">from</span> <span class="st">&#39;@angular/core&#39;</span><span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { v4 <span class="im">as</span> uuidv4 } <span class="im">from</span> <span class="st">&#39;uuid&#39;</span><span class="op">;</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Injectable</span>({</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  providedIn<span class="op">:</span> <span class="st">&#39;root&#39;</span><span class="op">,</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> CorrelationService {</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetConversationId</span>() {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getConversationId</span>() {</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCorrelationId</span>() {</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>() {}</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now the tests pass or fail as expected.</p>
<h2 id="make-it-right">Make It Right</h2>
<p>This code looks pretty good, almost complete. There are two things I
think are missing.</p>
<p>The first is obvious: Subsequent calls
to <code>getConversationId</code> need to return the same value. This
means I need a place to store the value. There is also the scenario of
the ID’s initial value. How do we handle that?</p>
<p>I will tackle the second scenario first by
modifying <code>getConversationId</code> to return the stored value, and
also by modifying <code>resetConversationId</code> to set the stored
value. This will cause the tests to fail, but that is why we write them
in the first place. Right?</p>
<p>My modified service looks like this:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> CorrelationService {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  conversationId<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetConversationId</span>() {</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span> <span class="op">=</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span><span class="op">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getConversationId</span>() {</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span><span class="op">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCorrelationId</span>() {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>() {}</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>All the tests pass because I had the foresight to
call <code>resetConversationId</code> in the test expecting equality. In
reality, this was not a good idea. My motive was good, but I do not
believe a user should be forced to
call <code>resetConversationId</code> before
calling <code>getConversationId</code>. That should be up to the
code.</p>
<p>So, now I want to remove the call
to <code>resetConversationId</code> from the test, which will cause that
test to fail.</p>
<p>To enable that code to pass again, I need to modify the service to
ensure there is a value before returning it.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getConversationId</span>() {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now all my tests pass, the service does the modest job it is meant to
do, and my test coverage looks good.</p>
<h2 id="the-final-test">The Final Test</h2>
<p>Here is the final set of tests.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { TestBed } <span class="im">from</span> <span class="st">&#39;@angular/core/testing&#39;</span><span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { CorrelationService } <span class="im">from</span> <span class="st">&#39;./correlation.service&#39;</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="fu">fdescribe</span>(<span class="st">&#39;CorrelationService&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> service<span class="op">:</span> CorrelationService<span class="op">;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">beforeEach</span>(() <span class="kw">=&gt;</span> {</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    TestBed<span class="op">.</span><span class="fu">configureTestingModule</span>({})<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    service <span class="op">=</span> TestBed<span class="op">.</span><span class="fu">inject</span>(CorrelationService)<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">it</span>(<span class="st">&#39;should be created&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">expect</span>(service)<span class="op">.</span><span class="fu">toBeTruthy</span>()<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;resetConversationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return different values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;getConversationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return identical values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">getConversationId</span>()<span class="op">;</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="fu">toBeDefined</span>()<span class="op">;</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">describe</span>(<span class="st">&#39;getCorrelationId&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">it</span>(<span class="st">&#39;should return different values on subsequent calls&#39;</span><span class="op">,</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> firstId <span class="op">=</span> service<span class="op">.</span><span class="fu">getCorrelationId</span>()<span class="op">;</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> secondId <span class="op">=</span> service<span class="op">.</span><span class="fu">getCorrelationId</span>()<span class="op">;</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">expect</span>(firstId)<span class="op">.</span><span class="at">not</span><span class="op">.</span><span class="fu">toEqual</span>(secondId)<span class="op">;</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<h2 id="the-final-service">The Final Service</h2>
<p>Here is the entire service.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { Injectable } <span class="im">from</span> <span class="st">&#39;@angular/core&#39;</span><span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { v4 <span class="im">as</span> uuidv4 } <span class="im">from</span> <span class="st">&#39;uuid&#39;</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>@<span class="fu">Injectable</span>({</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  providedIn<span class="op">:</span> <span class="st">&#39;root&#39;</span><span class="op">,</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="im">export</span> <span class="kw">class</span> CorrelationService {</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  conversationId<span class="op">:</span> <span class="dt">string</span><span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">resetConversationId</span>() {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span> <span class="op">=</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span><span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getConversationId</span>() {</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="fu">resetConversationId</span>()</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">getCorrelationId</span>() {</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">uuidv4</span>()<span class="op">;</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">constructor</span>() {}</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>I probably could also dispense with the empty constructor, but
something in the back of my mind is preventing me from deleting it.</p>
<h2 id="refactoring-the-service">Refactoring the Service</h2>
<p>After I finished writing this, it occurred to me that there is a
better way to initialize the service than with the <code>||</code> in
<code>getConversationId</code>. Why not use the constructor to do its
job and construct the object and initialize its internal state?</p>
<h3 id="before">Before</h3>
<p>As you may recall (or just look up and see), the
<code>getConversationId</code> function looks like this:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">getConversationId</span>() {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span> <span class="op">||</span> <span class="kw">this</span><span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>If the value of <code>this.conversationId</code> is not defined, the
conditional “or” will cause the function on the right side to be
executed. That function’s side-effect is to initialize the value.
TypeScript’s conditional “short-circuiting” prevents it from being
called if <code>this.conversationId</code> already contains a value.</p>
<p>In this case, it is simple enough to follow, but you may be able
imagine that in more complex classes it may not be.</p>
<h3 id="after">After</h3>
<p>Instead, I will move the call to <code>resetConversationId</code>
into the constructor, guaranteeing that <code>this.conversationId</code>
will always have a value. Then, I can delete the conditional check from
the latter function.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">constructor</span>() {</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">this</span><span class="op">.</span><span class="fu">resetConversationId</span>()<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">getConversationId</span>() {</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">this</span><span class="op">.</span><span class="at">conversationId</span><span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>To me, this is much simpler code and captures the meaning more
clearly than before. Anyone looking at this code will understand that
the service pre-initializes its state immediately.</p>
<p>The tests still pass, as they should. This is why we write unit tests
in the first place, to ensure that changes to the implementation do not
break functionality.</p>
<h2 id="conclusion">Conclusion</h2>
<p>From start to finish, this experiment took me just over two hours to
complete (2:30 - 4:45 PM). I spent another 15 minutes or so doing the
above refactoring and writing about it.</p>
<p>The tests were easy to write because the service itself did not exist
when I began. By describing the tests as I expected them to work, the
service API practically wrote itself.</p>
<p>I am not convinced that a more complicated service or a UI component
will be as easy to write in this manner, but overall I am pleased with
the result.</p>
<p>I will probably continue to develop the project this way and can
honestly recommend that everyone should give it a try some time. You may
end being pleasantly surprised.</p>
</body>
</html>
